<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetHoarder</title>
    <!-- Style -->
        <link rel="stylesheet" href="new-style.css">
    <!-- Scripts -->
        <!-- React -->
            <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
            <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
            <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <!-- Local -->
            <script src="search.js"></script>
</head>
<body>
    <!-- Search Interface -->
    <div class="full-viewport center-flex" style="background-color: rgb(40, 10, 10);">
        <div class="flex-column" style="width:var(--interface-width)">

            <!-- Logo -->
            <div class="row-flex center-flex">
                <img src="img/logo.png" height="150px" style="margin-bottom: 20px;">
            </div>

            <!-- Search Bar -->
            <div class="row-flex" style="width:var(--interface-width); font-size: 30px;">
                <div style="padding: 15px; background-color: var(--red); color: white; border-radius: 10px 0px 0px 10px;" onclick="for (i of document.getElementsByClassName('filter-menu')) {i.classList.toggle('selected');}">
                    Images
                </div>
                <input placeholder="Search" id="searchbar">
            </div>

            <!-- Filters -->
            <div id="filter-wrapper">

                <!-- Image Filters -->
                <div class="filter-menu selected">
                    <div id="img-type-filters" class="row-flex center-flex">
                        <button value="photos" class="toggle-button" onclick="toggleButton(this);">Photos</button>
                        <button value="icons" class="toggle-button" onclick="toggleButton(this);">Icons</button>
                        <button value="textures" class="toggle-button" onclick="toggleButton(this);">Textures</button>
                        <button value="sprites" class="toggle-button" onclick="toggleButton(this);">Sprites</button>
                    </div>
                    <div id="img-size-filters" class="row-flex center-flex">
                        <button value="square" class="toggle-button" onclick="toggleButton(this);">Square</button>
                        <button value="wide" class="toggle-button" onclick="toggleButton(this);">Wide</button>
                        <button value="tall" class="toggle-button" onclick="toggleButton(this);">Tall</button>
                        <button value="16:9" class="toggle-button" onclick="toggleButton(this);">16:9</button>
                        <button value="4:3" class="toggle-button" onclick="toggleButton(this);">4:3</button>
                    </div>
                    <div id="img-color-filters" class="row-flex center-flex">
                        <button value="red" class="color-button" onclick="toggleButton(this);" style="background-color:red;">R</button>
                        <button value="orange" class="color-button" onclick="toggleButton(this);" style="background-color:orange;">O</button>
                        <button value="yellow" class="color-button" onclick="toggleButton(this);" style="background-color:yellow;">Y</button>
                        <button value="green" class="color-button" onclick="toggleButton(this);" style="background-color:green;">G</button>
                        <button value="blue" class="color-button" onclick="toggleButton(this);" style="background-color:blue;">B</button>
                        <button value="purple" class="color-button" onclick="toggleButton(this);" style="background-color:purple;">V</button>
                    </div>
                </div>

                <!-- Audio Filters -->
                <div class="filter-menu">
                    <div id="audio-type-filters" class="row-flex center-flex">
                        <button value="music" class="toggle-button" onclick="toggleButton(this);">Music</button>
                        <button value="effect" class="toggle-button" onclick="toggleButton(this);">Sound Effects</button>
                        <button value="ambient" class="toggle-button" onclick="toggleButton(this);">Ambient</button>
                        <button value="voice" class="toggle-button" onclick="toggleButton(this);">Voice</button>
                    </div>
                </div>

                <script>
                function toggleButton(button)
                {
                    button.classList.toggle("selected");
                }
                </script>
            </div>

        </div>
    </div>

    <!-- Top Bar -->

    <div id="top-bar" onclick="hide_results();">
        <img src="img/logo.png">
        <div class="center-flex">
            <input id="top-bar-search">
        </div>
    </div>
        
    <!-- Results Page -->
    <div id="results-page" class="full-viewport">
        <div id="gallery">

        </div>
        <div id="loading-menu" class="parent-size center-flex">
            <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
        </div>
    </div>

    <script type="text/babel">

        const test_assets = [
            {
                "type": "image",
                "file": "https://wallpapers.com/images/featured/cat-pictures-zc3gu0636kmldm04.jpg",
                "title": "The Orange",
                "width": 900,
                "height": 563,
            },
            {
                "type": "image",
                "file": "https://wallpaper-house.com/data/out/6/wallpaper2you_103955.jpg",
                "title": "Dinnertime",
                "width": 1920,
                "height": 1080,
            },
            {
                "type": "image",
                "file": "https://www.itl.cat/pngfile/big/47-478337_kitten-wallpapers-hd.jpg",
                "title": "Leo the Magnificent",
                "width": 1920,
                "height": 1200,
            },
            {
                "type": "image",
                "file": "https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fwww.kittyloaf.com%2Fwp-content%2Fuploads%2F2017%2F06%2FValentine_KittyLoaf_071417-375x375.png",
                "title": "Pancake",
                "width": 375,
                "height": 375,
            },


            {
                "type": "audio",
                "file": "https://static.wikia.nocookie.net/undertale/images/6/63/Another_Medium_music.ogg",
                "title": "Another Medium",
                "duration": 2*60+22,
            },
            {
                "type": "audio",
                "file": "https://static.wikia.nocookie.net/undertale/images/1/12/It%27s_Raining_Somewhere_Else_music.ogg",
                "title": "It's Raining Somewhere Else",
                "duration": 2*60+50,
            },
            {
                "type": "audio",
                "file": "https://static.wikia.nocookie.net/undertale/images/9/93/Waterfall_%28Soundtrack%29_music.ogg",
                "title": "Waterfall",
                "duration": 2*60+6,
            },
            {
                "type": "audio",
                "file": "https://ia902902.us.archive.org/31/items/01.smellsliketeenspirit/01.Smells%20Like%20Teen%20Spirit.mp3",
                "title": "Smells Like Teen Spirit",
                "duration": 5*60+1,
            },
        ]

        var current_audio = -1;
        var setting_time = false;
        var hover_time_counter = 0;

        function toggle_audio(new_audio)
        {
            if (new_audio == current_audio)
            {
                document.getElementById("audio-player-" + current_audio).pause();
                // document.getElementById("play-button-" + new_audio).style = "";
                current_audio = -1;
            }
            else
            {
                if (current_audio != -1)
                {
                    document.getElementById("audio-player-" + current_audio).pause();
                    // document.getElementById("play-button-" + current_audio).style = "";
                }
                document.getElementById("audio-player-" + new_audio).play();
                // document.getElementById("play-button-" + new_audio).style.backgroundImage = "url(https://icon-library.com/images/pause-icon-transparent/pause-icon-transparent-8.jpg)";
                current_audio = new_audio;
            }
        }

        function Entry({ data })
        {
            let asset = data; //test_assets[Math.floor(Math.random() * test_assets.length)]
            let asset_ID = asset.id //Math.floor(Math.random() * 2147483000);
            // if (Math.random() < 0.3)
            // {
            //     asset = test_assets[4 + Math.floor(Math.random() * 4)]
            //     asset_ID = Math.floor(Math.random() * 2147483000);
            // }

            if (asset.type == "image")
            {
                let style_content = ".entry-" + asset_ID + `:hover > .image-preview {
                    z-index: 10; ` + (asset.width > asset.height ? `
                    width: calc(100% * ` + (asset.width / asset.height)  + `);
                    ` : `width: 100%;
                    height: calc(100% * ` + (asset.height / asset.width)  + `);`) + `
                    transform: scale(1.1);
                }`;

                if (asset.height > asset.width)
                {
                    style_content += ".entry-" + asset_ID + ` .download-button {
                        aspect-ratio: 1;
                        width: 30%;
                        height: auto;
                    }`;
                }

                return (
                    <div className={"entry image-entry entry-" + asset_ID}>
                        <div className="image-preview"
                            style={{ backgroundImage: `url(${asset.file})` }}
                            loading="lazy">
                            <div className="entry-title">{asset.title}</div>
                            <a className="download-button" href={`/db/download/${asset.id}`} download></a>
                        </div>

                        {/* Preload the image to ensure it's fetched as soon as possible */}
                        <link rel="preload" href={asset.file} as="image" />

                        {/* Critical CSS for the image-entry styles */}
                        <style>{style_content}</style>
                    </div>

                );
            }
            else if (asset.type == "audio")
            {
                return (
                    <div id={"entry-" + asset_ID} className="entry audio-entry" onMouseOver={(event) => toggle_audio(asset_ID)} onMouseOut={(event) => toggle_audio(asset_ID)}>
                        <a id={"play-button-" + asset_ID} className={"audio-play-button"} href={asset.file} download></a>
                        <audio id={"audio-player-" + asset_ID}>
                            <source src={asset.file} type="audio/ogg" />
                        </audio>

                        <div className="entry-title" onMouseOver={(event) => setting_time = true} onMouseOut={(event) => setting_time = false}>
                            <div id={"media-progress-" + asset_ID} className="media-progress-bar">
                                <div className="media-progress-bar-tip"></div>
                            </div>
                            {asset.title}
                        </div>
                    </div>
                );
            }
        }

        function timer()
        {
            if (current_audio != -1)
            {
                document.getElementById("media-progress-" + current_audio).style.width = (document.getElementById("audio-player-" + current_audio).currentTime / document.getElementById("audio-player-" + current_audio).duration * 100) + "%";
            }
        }

        var mouseX = 0.0;
        var mouseY = 0.0;

        window.addEventListener("mousemove", event => {

            if (mouseX == event.clientX && mouseY == event.clientY)
                hover_time_counter = -10;

            mouseX = event.clientX;
            mouseY = event.clientY;

            if (setting_time)
            {
                hover_time_counter += 1;

                if (hover_time_counter >= 5)
                    document.getElementById("audio-player-" + current_audio).currentTime = (
                        document.getElementById("audio-player-" + current_audio).duration
                        * (event.clientX - document.getElementById("entry-" + current_audio).getBoundingClientRect().left)
                        / (document.getElementById("entry-" + current_audio).getBoundingClientRect().right - document.getElementById("entry-" + current_audio).getBoundingClientRect().left)
                    );
            }
            else
                hover_time_counter = 0;
        });

        async function update_results()
        {
            try
            {
                var entry_list = [];
                // Do NOT load more than 15 assets at a time or your browser will crash
                for (var i = 0; i < Math.min(15, results.length); i++)
                {
                    let entry = {
                        "type": results[i].Type,
                        "id": results[i].Id,
                        "file": results[i].StorageLocation,
                        "title": results[i].Name,
                    };
                    if (entry.type == "image")
                    {
                        entry.width = results[i].Width;
                        entry.height = results[i].Height;
                    }
                    entry_list.push(<Entry data={entry} />)
                }

                const container = document.getElementById('gallery');
                const root = ReactDOM.createRoot(container);
                root.render(entry_list);
            }
            catch (error)
            {
                console.error(error.message);
            }
        }

        function show_results()
        {
            document.getElementById("top-bar").classList.add("selected");
            document.getElementById("results-page").style.bottom = "0%";
            document.getElementById("top-bar-search").value = document.getElementById("searchbar").value
            gallery_open = true;
        }

        function hide_results()
        {
            document.getElementById("top-bar").classList.remove("selected");
            document.getElementById("results-page").style.bottom = "";
            gallery_open = false;

            document.getElementById("searchbar").focus();
        }

        setInterval(timer, 33);

    </script>

</body>
</html>